name: Deploy to aaPanel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy and Build on Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            echo "=== Step 1: Stop PM2 ==="
            pm2 delete all || true
            
            echo "=== Step 2: Delete and recreate directory ==="
            # Remove immutable attribute from protected files (aaPanel creates .user.ini with immutable flag)
            chattr -i /www/wwwroot/ihelp.team/.user.ini 2>/dev/null || true
            rm -rf /www/wwwroot/ihelp.team
            mkdir -p /www/wwwroot/ihelp.team
            
            echo "=== Step 3: Clone fresh from GitHub ==="
            cd /www/wwwroot/ihelp.team
            git clone https://github.com/ssm82009/ihelpteam.git .
            
            echo "=== Step 4: Create .env file ==="
            cat <<EOF > .env
            TURSO_DATABASE_URL=${{ secrets.TURSO_DATABASE_URL }}
            TURSO_AUTH_TOKEN=${{ secrets.TURSO_AUTH_TOKEN }}
            PAYLINK_API_ID=${{ secrets.PAYLINK_API_ID }}
            PAYLINK_SECRET_KEY=${{ secrets.PAYLINK_SECRET_KEY }}
            PAYLINK_BASE_URL=${{ secrets.PAYLINK_BASE_URL }}
            NEXT_PUBLIC_BASE_URL=https://ihelp.team
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            ADMIN_TOKEN_SECRET=${{ secrets.ADMIN_TOKEN_SECRET }}
            EOF
            
            echo "=== Step 5: Install dependencies ==="
            npm install
            
            echo "=== Step 6: Build the project ==="
            npm run build
            
            echo "=== Step 7: Setup Standalone for Production ==="
            # 1. إعداد مجلد standalone للعمل عبر PM2
            mkdir -p .next/standalone/.next/static
            cp -r .next/static/* .next/standalone/.next/static/
            cp -r public .next/standalone/public
            cp .env .next/standalone/.env
            
            # 2. إعداد مجلد الـ root لخدمة الملفات عبر Nginx مباشرة (حل مشكلة الـ 404)
            mkdir -p _next/static
            cp -r .next/static/* _next/static/
            cp -r public/* . 2>/dev/null || true
            
            # 3. ضبط الأذونات لمستخدم النظاام www (مهم جداً في aaPanel)
            chown -R www:www /www/wwwroot/ihelp.team
            chmod -R 755 /www/wwwroot/ihelp.team
            
            echo "=== Step 8: Create ecosystem.config.js ==="
            cat <<EOF > .next/standalone/ecosystem.config.js
            module.exports = {
              apps: [{
                name: 'ihelp-team',
                script: 'server.js',
                cwd: '/www/wwwroot/ihelp.team/.next/standalone',
                env: {
                  PORT: 3010,
                  NODE_ENV: 'production',
                  HOSTNAME: '0.0.0.0'
                }
              }]
            };
            EOF
            
            echo "=== Step 9: Start PM2 ==="
            cd .next/standalone
            # تشغيل PM2 كمستخدم www لضمان الأمان وتوافق الملفات
            sudo -u www pm2 delete ihelp-team || true
            sudo -u www pm2 start ecosystem.config.js
            sudo -u www pm2 save
            
            echo "=== Deployment Complete! ==="
