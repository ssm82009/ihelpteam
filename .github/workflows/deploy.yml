name: Build and Deploy to aaPanel

on:
  push:
    branches:
      - main  # أو اسم الفرع الرئيسي لديك

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Next.js App
        run: npm run build
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          PAYLINK_API_ID: ${{ secrets.PAYLINK_API_ID }}
          PAYLINK_SECRET_KEY: ${{ secrets.PAYLINK_SECRET_KEY }}
          PAYLINK_BASE_URL: ${{ secrets.PAYLINK_BASE_URL }}
          NEXT_PUBLIC_BASE_URL: https://ihelp.team
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}

      - name: Prepare Standalone Build
        run: |
          cp -r public .next/standalone/
          cp -r .next/static .next/standalone/.next/
          # Create a zip for faster transfer
          cd .next/standalone
          zip -r ../../deploy.zip .

      - name: Deploy to Server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "deploy.zip"
          target: "/www/wwwroot/ihelp.team"

      - name: Finalize Deployment on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Ensure unzip is installed
            if ! command -v unzip &> /dev/null; then
                if command -v apt-get &> /dev/null; then
                    sudo apt-get update && sudo apt-get install -y unzip
                elif command -v yum &> /dev/null; then
                    sudo yum install -y unzip
                fi
            fi

            cd /www/wwwroot/ihelp.team
            if [ -f "deploy.zip" ]; then
                unzip -o deploy.zip
                rm deploy.zip
            else
                echo "Error: deploy.zip not found!"
                exit 1
            fi

            # Create .env file for runtime secrets
            cat <<EOF > .env
            TURSO_DATABASE_URL=${{ secrets.TURSO_DATABASE_URL }}
            TURSO_AUTH_TOKEN=${{ secrets.TURSO_AUTH_TOKEN }}
            PAYLINK_API_ID=${{ secrets.PAYLINK_API_ID }}
            PAYLINK_SECRET_KEY=${{ secrets.PAYLINK_SECRET_KEY }}
            PAYLINK_BASE_URL=${{ secrets.PAYLINK_BASE_URL }}
            NEXT_PUBLIC_BASE_URL=https://ihelp.team
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            ADMIN_TOKEN_SECRET=${{ secrets.ADMIN_TOKEN_SECRET }}
            EOF
            
            # Create ecosystem.config.js for PM2
            cat <<EOF > ecosystem.config.js
            module.exports = {
              apps: [{
                name: 'ihelp-team',
                script: 'server.js',
                interpreter: 'node',
                env: {
                  PORT: 3010,
                  NODE_ENV: 'production'
                }
              }]
            };
            EOF

            # Reload application
            pm2 reload ihelp-team || pm2 start ecosystem.config.js
            pm2 save
